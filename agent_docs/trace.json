{
  "module_name": "trace",
  "description": "RocketMQ消息跟踪模块，用于收集和分发消息产生、消费和存储过程中的跟踪信息",
  "analyze_date": "2025-12-10",
  "module_structure": {
    "files": [
      {
        "name": "__init__.py",
        "path": "src/pyrocketmq/trace/__init__.py",
        "type": "module_entry",
        "description": "模块入口文件，导出主要类和枚举",
        "exports": ["AccessChannel", "TraceConfig"]
      },
      {
        "name": "config.py",
        "path": "src/pyrocketmq/trace/config.py",
        "type": "configuration",
        "description": "定义跟踪相关的配置类和枚举",
        "components": [
          {
            "name": "AccessChannel",
            "type": "Enum",
            "values": ["LOCAL=0", "CLOUD=1"],
            "description": "访问通道枚举，定义连接类型（本地IDC集群或云服务）"
          },
          {
            "name": "TraceConfig",
            "type": "DataClass",
            "description": "跟踪配置的核心类",
            "required_fields": [
              {
                "name": "trace_topic",
                "type": "str",
                "description": "跟踪消息的主题名称"
              },
              {
                "name": "group_name",
                "type": "str",
                "description": "跟踪生产者组名"
              },
              {
                "name": "access",
                "type": "AccessChannel",
                "description": "访问通道类型"
              },
              {
                "name": "namesrv_addr",
                "type": "str",
                "description": "NameServer地址"
              }
            ],
            "optional_fields": [
              {
                "name": "max_batch_size",
                "type": "int",
                "default": 20,
                "description": "批量处理的最大消息数量"
              },
              {
                "name": "max_msg_size",
                "type": "int",
                "default": 4194304,
                "description": "单个消息的最大大小（4MB）"
              }
            ],
            "factory_methods": [
              {
                "name": "create_local_config",
                "description": "创建本地集群配置"
              },
              {
                "name": "create_cloud_config",
                "description": "创建云服务配置"
              }
            ],
            "validation": true,
            "post_init_validation": true
          }
        ]
      },
      {
        "name": "trace_dispatcher.py",
        "path": "src/pyrocketmq/trace/trace_dispatcher.py",
        "type": "core_dispatcher",
        "description": "同步版本的跟踪消息分发器",
        "architecture": {
          "modules": [
            {
              "name": "生命周期管理模块",
              "functions": ["__init__", "start", "stop"],
              "responsibility": "管理分发器的启动、停止和资源清理"
            },
            {
              "name": "数据处理模块",
              "functions": ["dispatch", "_flush_worker", "_commit"],
              "data_flow": "dispatch -> 队列 -> _flush_worker -> _commit -> 消息路由模块",
              "responsibility": "处理跟踪数据的接收、批处理和提交"
            },
            {
              "name": "消息路由与发送模块",
              "functions": [
                "_flush",
                "_send_trace_data_by_mq",
                "_send_message_to_broker",
                "update_route_info"
              ],
              "responsibility": "管理消息路由、Broker选择和实际的消息传输"
            }
          ]
        },
        "features": [
          "线程安全的队列管理",
          "批量处理优化",
          "消息大小自动分割",
          "动态路由信息更新",
          "连接池管理",
          "完善的错误处理和日志"
        ]
      },
      {
        "name": "async_trace_dispatcher.py",
        "path": "src/pyrocketmq/trace/async_trace_dispatcher.py",
        "type": "async_dispatcher",
        "description": "异步版本的跟踪消息分发器",
        "differences_from_sync": [
          "所有方法都是异步的（async/await）",
          "使用异步任务（asyncio.Task）替代线程",
          "使用异步锁（asyncio.Lock）替代线程锁",
          "使用 asyncio.gather 实现并发发送"
        ],
        "architecture": {
          "modules": [
            {
              "name": "生命周期管理模块",
              "functions": ["__init__", "start", "stop"],
              "responsibility": "管理异步分发器的启动、停止和资源清理"
            },
            {
              "name": "数据处理模块",
              "functions": ["dispatch", "_flush_worker", "_commit"],
              "data_flow": "dispatch -> 队列 -> _flush_worker -> _commit -> 消息路由模块",
              "responsibility": "异步处理跟踪数据的接收、批处理和提交",
              "concurrency": "使用 asyncio.gather 实现并发发送"
            },
            {
              "name": "消息路由与发送模块",
              "functions": [
                "_flush",
                "_send_trace_data_by_mq",
                "_send_message_to_broker",
                "update_route_info"
              ],
              "responsibility": "异步管理消息路由、Broker选择和实际的消息传输"
            }
          ]
        },
        "features": [
          "异步队列管理",
          "并发批量处理",
          "异步连接池",
          "超时和取消支持",
          "高性能异步I/O"
        ]
      },
      {
        "name": "config.json",
        "path": "src/pyrocketmq/trace/config.json",
        "type": "documentation",
        "description": "配置文件的JSON表示（自动生成的AST文档）"
      }
    ]
  },
  "design_patterns": [
    {
      "name": "生产者-消费者模式",
      "description": "dispatch方法生产数据到队列，_flush_worker消费者从队列取数据处理",
      "implementation": "队列 + 线程/任务"
    },
    {
      "name": "策略模式",
      "description": "AccessChannel枚举定义不同的访问策略，工厂方法创建相应配置",
      "implementation": "枚举 + 工厂方法"
    },
    {
      "name": "批处理模式",
      "description": "消息累积到一定数量或大小后批量发送，优化网络传输",
      "implementation": "队列批量处理 + 消息大小分割"
    },
    {
      "name": "观察者模式",
      "description": "使用事件机制进行线程/任务间通信",
      "implementation": "threading.Event / asyncio.Event"
    }
  ],
  "key_features": {
    "performance": [
      "批量处理减少网络调用",
      "异步版本支持并发发送",
      "连接池管理复用连接",
      "消息大小自动分割和优化"
    ],
    "reliability": [
      "完善的错误处理和日志记录",
      "线程安全/异步安全设计",
      "优雅的启动和停止机制",
      "超时和重试支持"
    ],
    "scalability": [
      "清晰的模块划分便于扩展",
      "配置驱动的设计",
      "同步/异步双实现选择",
      "动态���由信息更新"
    ]
  },
  "usage_examples": {
    "sync_usage": {
      "config": "config = TraceConfig.create_local_config(trace_topic, group_name, namesrv_addr)",
      "dispatcher": "dispatcher = TraceDispatcher(config)",
      "lifecycle": "dispatcher.start() -> dispatcher.dispatch(ctx) -> dispatcher.stop()"
    },
    "async_usage": {
      "config": "config = TraceConfig.create_local_config(trace_topic, group_name, namesrv_addr)",
      "dispatcher": "dispatcher = AsyncTraceDispatcher(config)",
      "lifecycle": "await dispatcher.start() -> await dispatcher.dispatch(ctx) -> await dispatcher.stop()"
    }
  },
  "dependencies": {
    "internal": [
      "pyrocketmq.broker",
      "pyrocketmq.nameserver",
      "pyrocketmq.queue_helper",
      "pyrocketmq.remote",
      "pyrocketmq.model",
      "pyrocketmq.transport"
    ],
    "external": ["threading", "asyncio", "collections", "dataclasses", "enum"]
  },
  "constants": {
    "RmqSysTraceTopic": "RMQ_SYS_TRACE_TOPIC",
    "TraceTopicPrefix": "rmq_sys_TRACE_DATA_",
    "TraceGroupName": "_INNER_TRACE_PRODUCER"
  }
}
